generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = env("DB_PROVIDER")
  url      = env("DATABASE_URL")
}

enum BuyBoxStatus {
  WIN
  LOSE
  UNKNOWN
}

enum ServiceFeeType {
  FIXED
  PERCENT
}

enum MinProfitType {
  SAR
  PERCENT
}

enum PriceChangeMethod {
  SUGGESTED
  CUSTOM
}

enum AlertType {
  LOST_BUYBOX
  COMPETITOR_DROP
  NOT_COMPETITIVE
  SAFE_REPRICE
  PRICE_WAR
}

enum AlertSeverity {
  INFO
  WARN
  CRITICAL
}

enum VatMode {
  INCLUSIVE
  EXCLUSIVE
}

model User {
  id           String           @id @default(cuid())
  email        String           @unique
  name         String?
  passwordHash String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  priceChanges PriceChangeLog[]
}

model Product {
  id               String           @id @default(cuid())
  sku              String           @unique
  barcode          String?          @db.VarChar(64)
  title            String
  trendyolProductId String?         @db.VarChar(128)
  category         String?
  active           Boolean          @default(true)
  currency         String           @default("SAR")
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  settings         ProductSettings?
  snapshots        PriceSnapshot[]
  alerts           Alert[]
  priceChanges     PriceChangeLog[]

  @@index([barcode])
}

model GlobalSettings {
  id                     String         @id @default(cuid())
  currency               String         @default("SAR")
  commissionRate         Decimal        @default(0.15) @db.Decimal(10, 4)
  serviceFeeType         ServiceFeeType @default(PERCENT)
  serviceFeeValue        Decimal        @default(0) @db.Decimal(10, 4)
  shippingCost           Decimal        @default(0) @db.Decimal(10, 2)
  handlingCost           Decimal        @default(0) @db.Decimal(10, 2)
  vatRate                Decimal        @default(15) @db.Decimal(5, 2)
  vatMode                VatMode        @default(INCLUSIVE)
  minProfitType          MinProfitType  @default(SAR)
  minProfitValue         Decimal        @default(0) @db.Decimal(10, 2)
  undercutStep           Decimal        @default(0.5) @db.Decimal(10, 2)
  alertThresholdSar      Decimal        @default(2) @db.Decimal(10, 2)
  alertThresholdPct      Decimal        @default(1) @db.Decimal(10, 2)
  cooldownMinutes        Int            @default(15)
  competitorDropPct      Decimal        @default(3) @db.Decimal(10, 2)
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
}

model ProductSettings {
  id                   String         @id @default(cuid())
  productId            String         @unique
  costPrice            Decimal        @db.Decimal(10, 2)
  commissionRate       Decimal?       @db.Decimal(10, 4)
  serviceFeeType       ServiceFeeType?
  serviceFeeValue      Decimal?       @db.Decimal(10, 4)
  shippingCost         Decimal?       @db.Decimal(10, 2)
  handlingCost         Decimal?       @db.Decimal(10, 2)
  vatRate              Decimal?       @db.Decimal(5, 2)
  vatMode              VatMode?
  minProfitType        MinProfitType?
  minProfitValue       Decimal?       @db.Decimal(10, 2)
  undercutStep         Decimal?       @db.Decimal(10, 2)
  alertThresholdSar    Decimal?       @db.Decimal(10, 2)
  alertThresholdPct    Decimal?       @db.Decimal(10, 2)
  cooldownMinutes      Int?
  competitorDropPct    Decimal?       @db.Decimal(10, 2)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model PriceSnapshot {
  id                 String       @id @default(cuid())
  productId          String
  checkedAt          DateTime     @default(now())
  ourPrice           Decimal?     @db.Decimal(10, 2)
  competitorMinPrice Decimal?     @db.Decimal(10, 2)
  competitorCount    Int?
  buyboxStatus       BuyBoxStatus @default(UNKNOWN)
  buyboxSellerId     String?
  rawPayloadJson     Json?

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, checkedAt(sort: Desc)])
}

model Alert {
  id           String        @id @default(cuid())
  productId    String
  createdAt    DateTime      @default(now())
  type         AlertType
  severity     AlertSeverity
  message      String
  metadataJson Json?
  isRead       Boolean       @default(false)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([isRead, createdAt(sort: Desc)])
}

model PriceChangeLog {
  id                  String            @id @default(cuid())
  productId           String
  createdAt           DateTime          @default(now())
  oldPrice            Decimal?          @db.Decimal(10, 2)
  newPrice            Decimal           @db.Decimal(10, 2)
  method              PriceChangeMethod
  requestedByUserId   String?
  trendyolResponseJson Json?

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  requestedByUser User? @relation(fields: [requestedByUserId], references: [id], onDelete: SetNull)

  @@index([productId, createdAt(sort: Desc)])
}

model JobLock {
  id          String   @id @default(cuid())
  name        String   @unique
  owner       String
  lockedUntil DateTime
  updatedAt   DateTime @updatedAt
}

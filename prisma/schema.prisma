generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BuyBoxStatus {
  WIN
  LOSE
  UNKNOWN
}

enum ServiceFeeType {
  FIXED
  PERCENT
}

enum MinProfitType {
  SAR
  PERCENT
}

enum PriceChangeMethod {
  SUGGESTED
  CUSTOM
}

enum AlertType {
  LOST_BUYBOX
  COMPETITOR_DROP
  NOT_COMPETITIVE
  SAFE_REPRICE
  PRICE_WAR
}

enum AlertSeverity {
  INFO
  WARN
  CRITICAL
}

enum VatMode {
  INCLUSIVE
  EXCLUSIVE
}

model User {
  id           String           @id @default(cuid())
  email        String           @unique
  name         String?
  passwordHash String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  priceChanges PriceChangeLog[]
}

model Product {
  id                String           @id @default(cuid())
  sku               String           @unique
  barcode           String?
  title             String
  trendyolProductId String?
  category          String?
  active            Boolean          @default(true)
  currency          String           @default("SAR")
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  settings     ProductSettings?
  snapshots    PriceSnapshot[]
  alerts       Alert[]
  priceChanges PriceChangeLog[]

  @@index([barcode])
}

model GlobalSettings {
  id                String         @id @default(cuid())
  currency          String         @default("SAR")
  commissionRate    Decimal        @default(0.15)
  serviceFeeType    ServiceFeeType @default(PERCENT)
  serviceFeeValue   Decimal        @default(0)
  shippingCost      Decimal        @default(0)
  handlingCost      Decimal        @default(0)
  vatRate           Decimal        @default(15)
  vatMode           VatMode        @default(INCLUSIVE)
  minProfitType     MinProfitType  @default(SAR)
  minProfitValue    Decimal        @default(0)
  undercutStep      Decimal        @default(0.5)
  alertThresholdSar Decimal        @default(2)
  alertThresholdPct Decimal        @default(1)
  cooldownMinutes   Int            @default(15)
  competitorDropPct Decimal        @default(3)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

model ProductSettings {
  id                String         @id @default(cuid())
  productId         String         @unique
  costPrice         Decimal
  commissionRate    Decimal?
  serviceFeeType    ServiceFeeType?
  serviceFeeValue   Decimal?
  shippingCost      Decimal?
  handlingCost      Decimal?
  vatRate           Decimal?
  vatMode           VatMode?
  minProfitType     MinProfitType?
  minProfitValue    Decimal?
  undercutStep      Decimal?
  alertThresholdSar Decimal?
  alertThresholdPct Decimal?
  cooldownMinutes   Int?
  competitorDropPct Decimal?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model PriceSnapshot {
  id                 String       @id @default(cuid())
  productId          String
  checkedAt          DateTime     @default(now())
  ourPrice           Decimal?
  competitorMinPrice Decimal?
  competitorCount    Int?
  buyboxStatus       BuyBoxStatus @default(UNKNOWN)
  buyboxSellerId     String?
  rawPayloadJson     Json?

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, checkedAt])
}

model Alert {
  id           String        @id @default(cuid())
  productId    String
  createdAt    DateTime      @default(now())
  type         AlertType
  severity     AlertSeverity
  message      String
  metadataJson Json?
  isRead       Boolean       @default(false)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([isRead, createdAt])
}

model PriceChangeLog {
  id                  String            @id @default(cuid())
  productId           String
  createdAt           DateTime          @default(now())
  oldPrice            Decimal?
  newPrice            Decimal
  method              PriceChangeMethod
  requestedByUserId   String?
  trendyolResponseJson Json?

  product         Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  requestedByUser User?   @relation(fields: [requestedByUserId], references: [id], onDelete: SetNull)

  @@index([productId, createdAt])
}

model JobLock {
  id          String   @id @default(cuid())
  name        String   @unique
  owner       String
  lockedUntil DateTime
  updatedAt   DateTime @updatedAt
}

model ShipmentPackage {
  id                 String   @id @default(cuid())
  sellerId           BigInt
  packageNumber      String
  orderNumber        String?
  status             String
  cargoProvider      String?
  trackingNumber     String?
  trackingLink       String?
  
  lastModifiedAt     DateTime?
  createdAt          DateTime?
  estimatedDeliveryStart DateTime?
  estimatedDeliveryEnd   DateTime?
  
  linesCount         Int?
  rawPayload         Json
  syncedAt           DateTime @default(now())

  @@unique([sellerId, packageNumber])
  @@index([status])
  @@index([lastModifiedAt(sort: Desc)])
  @@index([syncedAt(sort: Desc)])
  @@map("shipment_packages")
}

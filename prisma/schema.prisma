generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BuyBoxStatus {
  WIN
  LOSE
  UNKNOWN
}

enum ServiceFeeType {
  FIXED
  PERCENT
}

enum MinProfitType {
  SAR
  PERCENT
}

enum PriceChangeMethod {
  SUGGESTED
  CUSTOM
}

enum AlertType {
  LOST_BUYBOX
  COMPETITOR_DROP
  NOT_COMPETITIVE
  SAFE_REPRICE
  PRICE_WAR
  MISSING_PRODUCT_DATA
}

enum AlertSeverity {
  INFO
  WARN
  CRITICAL
}

enum VatMode {
  INCLUSIVE
  EXCLUSIVE
}

model User {
  id           String           @id @default(cuid())
  email        String           @unique
  name         String?
  passwordHash String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  priceChanges PriceChangeLog[]
}

model Product {
  id                String           @id @default(cuid())
  sku               String           @unique
  barcode           String?
  title             String
  trendyolProductId String?
  category          String?
  active            Boolean          @default(true)
  currency          String           @default("SAR")
  sallaProductId    String?
  sallaSku          String?
  sallaName         String?
  sallaQuantity     Int?
  sallaPreTaxPrice  Decimal?
  sallaCostPrice    Decimal?
  sallaMatchMethod  String?
  sallaMatchScore   Decimal?
  sallaLastSyncedAt DateTime?
  sallaRawPayload   Json?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  settings       ProductSettings?
  snapshots      PriceSnapshot[]
  alerts         Alert[]
  priceChanges   PriceChangeLog[]
  competitorLogs CompetitorLog[]

  @@index([barcode])
}

model GlobalSettings {
  id                String         @id @default(cuid())
  currency          String         @default("SAR")
  commissionRate    Decimal        @default(0.15)
  serviceFeeType    ServiceFeeType @default(PERCENT)
  serviceFeeValue   Decimal        @default(0)
  shippingCost      Decimal        @default(0)
  handlingCost      Decimal        @default(0)
  vatRate           Decimal        @default(15)
  vatMode           VatMode        @default(INCLUSIVE)
  minProfitType     MinProfitType  @default(SAR)
  minProfitValue    Decimal        @default(0)
  undercutStep      Decimal        @default(0.5)
  alertThresholdSar Decimal        @default(2)
  alertThresholdPct Decimal        @default(1)
  cooldownMinutes   Int            @default(15)
  competitorDropPct Decimal        @default(3)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

model ProductSettings {
  id                String         @id @default(cuid())
  productId         String         @unique
  costPrice         Decimal
  commissionRate    Decimal?
  serviceFeeType    ServiceFeeType?
  serviceFeeValue   Decimal?
  shippingCost      Decimal?
  handlingCost      Decimal?
  vatRate           Decimal?
  vatMode           VatMode?
  minProfitType     MinProfitType?
  minProfitValue    Decimal?
  undercutStep      Decimal?
  alertThresholdSar Decimal?
  alertThresholdPct Decimal?
  cooldownMinutes   Int?
  competitorDropPct Decimal?

  // Auto-Pilot Fields
  autoPilot         Boolean           @default(false)
  minPrice          Decimal?
  strategy          AutoPilotStrategy @default(MATCH)

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

enum AutoPilotStrategy {
  MATCH
  BEAT_BY_1
  BEAT_BY_5
}



model CompetitorLog {
  id             String   @id @default(cuid())
  productId      String
  competitorName String
  price          Decimal
  isBuyBoxWinner Boolean  @default(false)
  checkedAt      DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, checkedAt])
  @@index([competitorName])
  @@map("competitor_logs")
}

model PriceSnapshot {
  id                 String       @id @default(cuid())
  productId          String
  checkedAt          DateTime     @default(now())
  ourPrice           Decimal?
  competitorMinPrice Decimal?
  competitorCount    Int?
  buyboxStatus       BuyBoxStatus @default(UNKNOWN)
  buyboxSellerId     String?
  rawPayloadJson     Json?

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, checkedAt])
}

model Alert {
  id           String        @id @default(cuid())
  productId    String
  createdAt    DateTime      @default(now())
  type         AlertType
  severity     AlertSeverity
  message      String
  metadataJson Json?
  isRead       Boolean       @default(false)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([isRead, createdAt])
}

model PriceChangeLog {
  id                  String            @id @default(cuid())
  productId           String
  createdAt           DateTime          @default(now())
  oldPrice            Decimal?
  newPrice            Decimal
  method              PriceChangeMethod
  requestedByUserId   String?
  trendyolResponseJson Json?

  product         Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  requestedByUser User?   @relation(fields: [requestedByUserId], references: [id], onDelete: SetNull)

  @@index([productId, createdAt])
}

model SallaCredential {
  id                  String   @id @default(cuid())
  key                 String   @unique @default("default")
  merchantId          String?
  accessTokenEncoded  String
  refreshTokenEncoded String?
  tokenType           String?
  scope               String?
  expiresAt           DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("salla_credentials")
}

model JobLock {
  id          String   @id @default(cuid())
  name        String   @unique
  owner       String
  lockedUntil DateTime
  updatedAt   DateTime @updatedAt
}

model ShipmentPackage {
  id                 String   @id @default(cuid())
  sellerId           BigInt
  packageNumber      String
  orderNumber        String?
  status             String
  cargoProvider      String?
  trackingNumber     String?
  trackingLink       String?
  
  lastModifiedAt     DateTime?
  createdAt          DateTime?
  estimatedDeliveryStart DateTime?
  estimatedDeliveryEnd   DateTime?
  
  linesCount         Int?
  rawPayload         Json
  syncedAt           DateTime @default(now())

  @@unique([sellerId, packageNumber])
  @@index([status])
  @@index([lastModifiedAt(sort: Desc)])
  @@index([syncedAt(sort: Desc)])
  @@map("shipment_packages")
}

model Order {
  id                 String      @id @default(cuid())
  orderNumber        String      @unique
  sellerId           BigInt
  status             String      // Created, Picking, Shipped, Cancelled, Delivered, Returned, etc.
  totalPrice         Decimal
  currency           String      @default("SAR")
  customerFirstName  String?
  customerLastName   String?
  customerEmail      String?
  tcIdentityNumber   String?
  
  createdDate        DateTime
  estimatedDeliveryStart DateTime?
  estimatedDeliveryEnd   DateTime?
  
  items              OrderItem[]
  shipmentPackageId  String?
  
  updatedAt          DateTime    @updatedAt
  
  @@index([status])
  @@index([sellerId])
  @@index([createdDate(sort: Desc)])
  @@map("orders")
}

model OrderItem {
  id                 String   @id @default(cuid())
  orderId            String
  
  productName        String
  sku                String
  barcode            String?
  
  quantity           Int
  price              Decimal
  vatBaseAmount      Decimal?
  merchantSku        String?
  
  currency           String   @default("SAR")
  
  // Relations
  order              Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  @@index([orderId])
  @@index([sku])
  @@map("order_items")
}

model ReturnRequest {
  id              String   @id @default(cuid())
  claimId         String   @unique
  
  orderNumber     String?
  
  dateTime        DateTime
  reason          String
  status          String   // Created, Approved, Rejected being processed
  returnStatus    String?  // Actual return shipment status
  
  customerFirstName String?
  customerLastName  String?
  
  items           ReturnItem[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([status])
  @@index([orderNumber])
  @@map("return_requests")
}

model ReturnItem {
  id              String        @id @default(cuid())
  returnRequestId String
  
  sku             String
  quantity        Int
  reason          String?
  
  returnRequest   ReturnRequest @relation(fields: [returnRequestId], references: [id], onDelete: Cascade)
  
  @@index([returnRequestId])
  @@map("return_items")
}
